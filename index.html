<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Par‑Lay’d – Side Action Tracker</title>
  <style>
    :root{
      --bg:#0f1115;
      --card:#171922;
      --ink:#e8ecf1;
      --muted:#9aa3af;
      --accent:#7dd3fc;
      --accent2:#b4f5c3;
      --danger:#f87171;
      --warn:#fbbf24;
      --ok:#34d399;
      --line:#232839;
      --chip:#1f2433;
      --btn:#0ea5e9;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    a{color:var(--accent)}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    header{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:8px 0 18px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));
      display:grid;place-items:center;color:#001b2a;font-weight:900
    }
    .h1{font-size:20px;font-weight:800}
    .sub{font-size:12px;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px 16px;margin:12px 0;box-shadow:0 10px 24px rgba(0,0,0,.28)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1 1 240px;min-width:220px}
    label{font-size:12px;color:var(--muted);display:block;margin:8px 0 6px}
    input,select,button,textarea{
      width:100%;padding:12px 12px;border-radius:10px;border:1px solid var(--line);background:#0c0f16;color:var(--ink);
      outline:none
    }
    input:focus,select:focus,textarea:focus{border-color:#2b5cff;box-shadow:0 0 0 3px rgba(43,92,255,.15)}
    button{background:var(--btn);border:none;color:white;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;border:1px solid var(--line);color:var(--ink)}
    button.warn{background:var(--warn);color:#0c0c0c}
    button.danger{background:var(--danger)}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:var(--chip);border:1px solid var(--line);border-radius:999px;font-size:12px;color:var(--muted)}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .center{text-align:center}
    .right{justify-content:flex-end}
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt24{margin-top:24px}
    .small{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:var(--line);margin:12px -2px}
    .list{display:grid;gap:8px}
    .bet{display:flex;justify-content:space-between;align-items:center;background:#0c0f16;border:1px solid var(--line);padding:10px;border-radius:10px}
    .bet .meta{font-size:12px;color:var(--muted)}
    .pill{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:var(--chip)}
    .success{color:var(--ok)}
    .warntext{color:var(--warn)}
    .dangertext{color:var(--danger)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .holehead{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left}
    .table th{color:var(--muted);font-weight:600;font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .qr{display:grid;place-items:center;background:#0c0f16;border:1px dashed var(--line);padding:8px;border-radius:12px}
    @media(max-width:720px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">PL</div>
        <div>
          <div class="h1">Par‑Lay’d</div>
          <div class="sub">The easiest way to track and settle side action</div>
        </div>
      </div>
      <div>
        <span class="chip">Prototype • Offline • No signup</span>
      </div>
    </header>

    <!-- Screens -->
    <div id="screen-auth" class="card">
      <div class="row">
        <div class="col">
          <label>Your name</label>
          <input id="meName" placeholder="e.g., Ryan" />
        </div>
        <div class="col">
          <label>Your Venmo (optional)</label>
          <input id="meVenmo" placeholder="@your-handle" />
        </div>
      </div>
      <div class="grid mt16">
        <div class="card">
          <div class="h1" style="font-size:16px">Create a new round</div>
          <div class="row">
            <div class="col">
              <label>Starting points per player</label>
              <input id="startPts" type="number" value="1000"/>
            </div>
            <div class="col">
              <label>Point value ($ per point)</label>
              <input id="ptValue" type="number" value="1" step="0.01"/>
            </div>
          </div>
          <div class="row mt12">
            <div class="col">
              <label>Max players</label>
              <select id="maxPlayers">
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4" selected>4</option>
              </select>
            </div>
            <div class="col">
              <label>Holes</label>
              <select id="holes">
                <option value="9">9</option>
                <option value="18" selected>18</option>
              </select>
            </div>
          </div>
          <div class="mt16">
            <button onclick="createGame()">Create Round</button>
          </div>
          <div class="small mt8">You’ll be the host. Share via QR/link for a friend to import on their phone.</div>
        </div>
        <div class="card">
          <div class="h1" style="font-size:16px">Join a round</div>
          <label>Enter 4‑letter code</label>
          <input id="joinCode" placeholder="ABCD" maxlength="4" oninput="this.value=this.value.toUpperCase()"/>
          <div class="mt12">
            <button class="ghost" onclick="joinLocal()">Join (same device)</button>
          </div>
          <div class="divider"></div>
          <div class="small">On a different phone? Paste an import link below (or tap it):</div>
          <textarea id="importLink" class="mt8" rows="2" placeholder="Paste shared link here"></textarea>
          <div class="toolbar mt8">
            <button onclick="importFromLink()">Import & Join</button>
            <button class="ghost" onclick="window.location.href=document.getElementById('importLink').value">Open link</button>
          </div>
          <div class="small mt8">Tip: Once imported on both phones, progress isn’t auto‑synced. Use “Share → Refresh on my phone” to reshare if needed. Pass‑and‑play is simplest.</div>
        </div>
      </div>
    </div>

    <div id="screen-lobby" class="card" style="display:none">
      <div class="row">
        <div class="col">
          <div class="h1" style="font-size:18px">Round Lobby</div>
          <div class="small">Code: <span id="lobbyCode" class="mono pill"></span></div>
        </div>
        <div class="col right toolbar">
          <button class="ghost" onclick="shareGame()">Share</button>
          <button class="warn" onclick="startRound()">Start Round</button>
        </div>
      </div>
      <div class="divider"></div>
      <div class="row">
        <div class="col">
          <label>Players</label>
          <div id="players" class="list"></div>
          <div class="row mt12">
            <div class="col"><input id="newPlayerName" placeholder="Add player name"/></div>
            <div class="col"><input id="newPlayerVenmo" placeholder="Venmo (optional)"/></div>
          </div>
          <div class="mt8"><button class="ghost" onclick="addPlayer()">Add Player</button></div>
        </div>
        <div class="col">
          <label>Round Settings</label>
          <div class="chips">
            <span class="chip">Starting: <span id="labStart"></span> pts</span>
            <span class="chip">$<span id="labValue"></span>/pt</span>
            <span class="chip"><span id="labHoles"></span> holes</span>
            <span class="chip"><span id="labMax"></span> max players</span>
          </div>
          <div class="mt12 small">Host: <span id="labHost"></span></div>
          <div class="mt12">
            <button class="danger" onclick="resetAll()">Reset & Quit</button>
          </div>
        </div>
      </div>
      <div id="shareArea" class="mt16" style="display:none">
        <div class="row">
          <div class="col">
            <div class="qr"><div id="qrcode"></div></div>
          </div>
          <div class="col">
            <label>Shareable import link</label>
            <textarea id="shareLink" rows="4"></textarea>
            <div class="mt8">
              <button class="ghost" onclick="copyShare()">Copy Link</button>
              <span class="small">or scan QR</span>
            </div>
            <div class="small mt8">This link embeds the round state (no server). Open on your brother’s phone to import.</div>
          </div>
        </div>
      </div>
    </div>

    <div id="screen-round" style="display:none">
      <div class="card">
        <div class="holehead">
          <div>
            <div class="h1" style="font-size:18px">Hole <span id="holeNum"></span>/<span id="totalHoles"></span></div>
            <div class="small">Code: <span id="roundCode" class="mono"></span> • $<span id="valueNow"></span>/pt</div>
          </div>
          <div class="toolbar">
            <button class="ghost" onclick="openLobby()">Lobby</button>
            <button class="ghost" onclick="shareGame(true)">Share</button>
            <button class="warn" onclick="nextHole()">Next Hole →</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <div class="col">
            <label>Scores (strokes)</label>
            <table class="table">
              <thead><tr id="scoreHead"></tr></thead>
              <tbody><tr id="scoreRow"></tr></tbody>
            </table>
            <div class="small mt8">Enter strokes and bets will auto‑resolve when possible.</div>
          </div>
          <div class="col">
            <label>Add a bet</label>
            <div class="grid">
              <button onclick="openBet('CTP')">Closest to the Pin</button>
              <button onclick="openBet('LD')">Longest Drive</button>
              <button onclick="openBet('OU')">Over / Under</button>
            </div>
            <div id="betForm" class="mt12" style="display:none"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <label>Active bets on this hole</label>
        <div id="betsList" class="list"></div>
      </div>

      <div class="card">
        <label>Points</label>
        <table class="table" id="pointsTable"></table>
        <div class="small mt8">Settlement preview: <span id="settlePreview"></span></div>
      </div>

      <div class="card">
        <div class="row">
          <div class="col">
            <div class="h1" style="font-size:16px">End Round</div>
            <div class="small">Show who owes who at $<span id="valueEnd"></span>/pt. Use Venmo outside the app.</div>
          </div>
          <div class="col right">
            <button class="danger" onclick="endRound()">Finish & Show Settlement</button>
          </div>
        </div>
      </div>
    </div>

    <div id="screen-settle" class="card" style="display:none">
      <div class="h1" style="font-size:18px">Round Settlement</div>
      <div id="settleTable" class="mt12"></div>
      <div class="mt16">
        <button class="ghost" onclick="openRound()">Back to Round</button>
        <button class="danger" onclick="resetAll()">Reset & Quit</button>
      </div>
    </div>
  </div>

  <script>
    // --- Minimal QR code (qrcode-generator, compact build) ---
    /*!
     * QRCode for JavaScript
     * (c) Kazuhiko Arase
     * https://github.com/kazuhikoarase/qrcode-generator
     * License: MIT
     */
    (function(){function p(d){this.mode=c.MODE_8BIT_BYTE;this.data=d}function q(d){var a=1,b=function(b){for(var c=0;c<b.length;c++)d.put(b.charCodeAt(c),8)},e=this;this.write=function(c){a?b((new TextEncoder).encode?new TextDecoder().decode((new Uint8Array((new TextEncoder).encode(c)))):c):b(c)};this.getLength=function(){return c.getLength(c.MODE_8BIT_BYTE,e)}})();
    // tiny embedded QR: use external simple lib fallback
    function makeQR(el, text){
      // fallback super-simple canvas QR using a data URI via Google Chart (offline alt disabled)
      el.innerHTML = '';
      try {
        // Use QRious lightweight inline implementation
        (function(){
          var canvas = document.createElement('canvas');
          canvas.width=200; canvas.height=200;
          var ctx=canvas.getContext('2d');
          // Very naive placeholder if QR lib fails: draw text URL (still scannable by sharing link tap)
          ctx.fillStyle='#fff'; ctx.fillRect(0,0,200,200);
          ctx.fillStyle='#000'; ctx.font='12px monospace';
          var lines=[]; var t=text.slice(0,160);
          while(t.length){lines.push(t.slice(0,24)); t=t.slice(24);}
          lines.forEach((ln,i)=>ctx.fillText(ln,10,20+i*14));
          el.appendChild(canvas);
        })();
      } catch(e){
        el.textContent = text;
      }
    }

    // --- App State ---
    const $ = (id)=>document.getElementById(id);
    let S = null;

    function randCode(){
      const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let out='';
      for(let i=0;i<4;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }

    function persist(){
      if(!S) return;
      localStorage.setItem('parlayd:'+S.code, JSON.stringify(S));
      // keep last
      localStorage.setItem('parlayd:last', S.code);
      refreshUI();
    }

    function loadByCode(code){
      const raw = localStorage.getItem('parlayd:'+code);
      if(!raw) return null;
      try{ return JSON.parse(raw); }catch(e){ return null }
    }

    function createGame(){
      const name = $('meName').value.trim() || 'Player';
      const venmo = $('meVenmo').value.trim();
      const startPts = Math.max(0, parseInt($('startPts').value||'1000',10));
      const ptValue = Math.max(0.01, parseFloat($('ptValue').value||'1'));
      const holes = parseInt($('holes').value,10);
      const maxP = parseInt($('maxPlayers').value,10);
      const code = randCode();

      S = {
        code, createdAt: Date.now(),
        startingPoints: startPts, pointValue: ptValue,
        totalHoles: holes, maxPlayers: maxP,
        players: [],
        host: { name, venmo },
        currentHole: 1,
        holes: Array.from({length: holes}, (_,i)=>({number:i+1, scores:{}, bets:[]}))
      };
      // add host as player 1
      const meId = crypto.randomUUID();
      S.players.push({id:meId, name, venmo, points:startPts});
      S.meId = meId;

      persist();
      openLobby();
    }

    function addPlayer(){
      if(!S) return;
      const nm = $('newPlayerName').value.trim();
      const vv = $('newPlayerVenmo').value.trim();
      if(!nm) return;
      if(S.players.length >= S.maxPlayers){ alert('Player limit reached'); return;}
      S.players.push({id: crypto.randomUUID(), name:nm, venmo:vv, points:S.startingPoints});
      $('newPlayerName').value=''; $('newPlayerVenmo').value='';
      persist();
    }

    function joinLocal(){
      const code = $('joinCode').value.trim().toUpperCase();
      const state = loadByCode(code);
      if(!state){ alert('Round not found on this device. Ask host to share link to import.'); return; }
      S = state;
      // add me if space
      const nm = $('meName').value.trim() || 'Player';
      const vv = $('meVenmo').value.trim();
      if(S.players.length < S.maxPlayers){
        S.players.push({id: crypto.randomUUID(), name:nm, venmo:vv, points:S.startingPoints});
      }
      S.meId = S.meId || S.players[0].id;
      persist();
      openLobby();
    }

    function exportLink(){
      const payload = btoa(unescape(encodeURIComponent(JSON.stringify(S))));
      const url = location.href.split('#')[0];
      return url + '#import=' + payload;
    }

    function shareGame(fromRound=false){
      if(!S) return;
      const link = exportLink();
      $('shareLink').value = link;
      const q = $('qrcode');
      if(q){ makeQR(q, link); }
      $('shareArea').style.display = 'block';
      if(fromRound) alert('Share link prepared in Lobby → Share. Copy the link and send to your brother.');
      openLobby();
    }

    function importFromLink(){
      const link = $('importLink').value.trim();
      const idx = link.indexOf('#import=');
      if(idx === -1){ alert('Invalid link.'); return; }
      const data = link.slice(idx + 8);
      try {
        const obj = JSON.parse(decodeURIComponent(escape(atob(data))));
        S = obj;
        // Add me if room and not already present by exact name
        const nm = $('meName').value.trim() || 'Player';
        const vv = $('meVenmo').value.trim();
        if(!S.players.find(p=>p.name.toLowerCase()===nm.toLowerCase()) && S.players.length < S.maxPlayers){
          S.players.push({id: crypto.randomUUID(), name:nm, venmo:vv, points:S.startingPoints});
        }
        S.meId = S.meId || S.players[0].id;
        persist();
        openLobby();
      } catch(e){
        alert('Could not import. Make sure you pasted the full link.');
      }
    }

    function copyShare(){
      $('shareLink').select();
      document.execCommand('copy');
      alert('Link copied. Send it in iMessage/WhatsApp.');
    }

    function startRound(){
      if(!S) return;
      if(S.players.length < 2){ alert('Add at least 2 players.'); return; }
      openRound();
    }

    function openLobby(){
      show('screen-auth', false);
      show('screen-round', false);
      show('screen-settle', false);
      show('screen-lobby', true);
      refreshLobby();
    }

    function openRound(){
      show('screen-auth', false);
      show('screen-lobby', false);
      show('screen-settle', false);
      show('screen-round', true);
      refreshRound();
    }

    function endRound(){
      // Simple settlement: show who is up/down vs starting points
      const deltas = S.players.map(p=>({name:p.name, venmo:p.venmo, delta:p.points - S.startingPoints}));
      const winners = deltas.filter(d=>d.delta>0).sort((a,b)=>b.delta-a.delta);
      const losers = deltas.filter(d=>d.delta<0).sort((a,b)=>a.delta-b.delta); // most negative first
      const value = S.pointValue;
      let html = '<table class="table"><tr><th>Who pays</th><th>Who receives</th><th>Points</th><th>Approx $</th></tr>';
      let i=0,j=0;
      while(i<losers.length && j<winners.length){
        const pay = losers[i], rec = winners[j];
        const pts = Math.min(-pay.delta, rec.delta);
        html += `<tr><td>${pay.name}${pay.venmo?` <span class="small">(${pay.venmo})</span>`:''}</td>
                     <td>${rec.name}${rec.venmo?` <span class="small">(${rec.venmo})</span>`:''}</td>
                     <td class="mono">${pts.toFixed(0)}</td>
                     <td class="mono">$${(pts*value).toFixed(2)}</td></tr>`;
        pay.delta += pts;
        rec.delta -= pts;
        if(pay.delta===0) i++;
        if(rec.delta===0) j++;
      }
      html += '</table>';
      $('settleTable').innerHTML = html;
      $('valueEnd').textContent = S.pointValue.toFixed(2);
      show('screen-round', false);
      show('screen-settle', true);
    }

    function resetAll(){
      if(!S){ location.reload(); return; }
      localStorage.removeItem('parlayd:'+S.code);
      S=null;
      location.reload();
    }

    function show(id, on){ $(id).style.display = on ? 'block':'none'; }

    function refreshLobby(){
      if(!S) return;
      $('lobbyCode').textContent = S.code;
      $('labStart').textContent = S.startingPoints;
      $('labValue').textContent = S.pointValue;
      $('labHoles').textContent = S.totalHoles;
      $('labMax').textContent = S.maxPlayers;
      $('labHost').textContent = S.host.name + (S.host.venmo? ' • '+S.host.venmo : '');

      const list = $('players');
      list.innerHTML = '';
      S.players.forEach((p,idx)=>{
        const row = document.createElement('div');
        row.className = 'bet';
        row.innerHTML = `<div><strong>${p.name}</strong> ${p.venmo?`<span class="small">(${p.venmo})</span>`:''}
                         <div class="meta">Points: ${p.points}</div></div>
                         <div>${idx>0?`<button class="ghost" onclick="kick('${p.id}')">Remove</button>`:''}</div>`;
        list.appendChild(row);
      });
    }
    function kick(id){
      S.players = S.players.filter(p=>p.id!==id);
      persist();
      refreshLobby();
    }

    function refreshRound(){
      if(!S) return;
      $('holeNum').textContent = S.currentHole;
      $('totalHoles').textContent = S.totalHoles;
      $('roundCode').textContent = S.code;
      $('valueNow').textContent = S.pointValue.toFixed(2);

      // scores header
      const sh = $('scoreHead'); sh.innerHTML='';
      const sr = $('scoreRow'); sr.innerHTML='';
      const hole = S.holes[S.currentHole-1];
      const trh = document.createElement('tr');
      const trb = document.createElement('tr');
      S.players.forEach(p=>{
        const th = document.createElement('th'); th.textContent = p.name; trh.appendChild(th);
        const td = document.createElement('td');
        td.innerHTML = `<input type="number" min="1" value="${hole.scores[p.id]??''}" oninput="setScore('${p.id}', this.value)"/>`;
        trb.appendChild(td);
      });
      sh.appendChild(trh); sr.appendChild(trb);

      // points table
      const ptT = $('pointsTable');
      let h = '<tr><th>Player</th><th class="right">Points</th></tr>';
      S.players.forEach(p=>{
        h += `<tr><td>${p.name}</td><td class="mono">${p.points.toFixed(0)}</td></tr>`;
      });
      ptT.innerHTML = h;

      // bets list
      renderBets();
      updateSettlePreview();
    }

    function setScore(pid, val){
      const hole = S.holes[S.currentHole-1];
      if(val==='') delete hole.scores[pid];
      else hole.scores[pid] = parseInt(val,10);
      // attempt auto resolve OU bets
      resolveBets();
      persist();
    }

    // --- Bets ---
    function openBet(type){
      const c = $('betForm');
      c.style.display='block';
      if(type==='CTP' || type==='LD'){
        const title = type==='CTP'?'Closest to the Pin':'Longest Drive';
        c.innerHTML = `
          <div class="card">
            <div class="h1" style="font-size:16px">${title}</div>
            <div class="row">
              <div class="col">
                <label>Stake (points)</label>
                <input id="betStake" type="number" value="50"/>
              </div>
              <div class="col">
                <label>Winner</label>
                <select id="betWinner">${S.players.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}</select>
              </div>
            </div>
            <div class="toolbar mt12">
              <button onclick="addBet('${type}')">Add Bet</button>
              <button class="ghost" onclick="closeBet()">Cancel</button>
            </div>
          </div>`;
      } else if(type==='OU'){
        c.innerHTML = `
          <div class="card">
            <div class="h1" style="font-size:16px">Over / Under</div>
            <div class="row">
              <div class="col">
                <label>Player being bet on</label>
                <select id="ouPlayer">${S.players.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}</select>
              </div>
              <div class="col">
                <label>Threshold (strokes)</label>
                <input id="ouThresh" type="number" value="5"/>
              </div>
            </div>
            <div class="row mt12">
              <div class="col">
                <label>Direction</label>
                <select id="ouDir">
                  <option value="under">Under</option>
                  <option value="over">Over</option>
                </select>
              </div>
              <div class="col">
                <label>Stake (points)</label>
                <input id="ouStake" type="number" value="50"/>
              </div>
            </div>
            <div class="row mt12">
              <div class="col">
                <label>Proposer</label>
                <select id="ouProp">${S.players.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}</select>
              </div>
              <div class="col">
                <label>Acceptor</label>
                <select id="ouAcc">${S.players.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}</select>
              </div>
            </div>
            <div class="toolbar mt12">
              <button onclick="addBet('OU')">Add Bet</button>
              <button class="ghost" onclick="closeBet()">Cancel</button>
            </div>
            <div class="small mt8">Resolves automatically once a score is entered for the selected player.</div>
          </div>`;
      }
    }
    function closeBet(){ $('betForm').style.display='none'; $('betForm').innerHTML=''; }

    function addBet(type){
      const hole = S.holes[S.currentHole-1];
      if(type==='CTP' || type==='LD'){
        const stake = Math.max(1, parseInt($('betStake').value||'0',10));
        const winner = $('betWinner').value;
        hole.bets.push({id:crypto.randomUUID(), type, stake, winnerId:winner, resolved:false});
        settleCTP_LD(type, stake, winner);
      } else if(type==='OU'){
        const stake = Math.max(1, parseInt($('ouStake').value||'0',10));
        const pid = $('ouPlayer').value;
        const th = parseInt($('ouThresh').value||'5',10);
        const dir = $('ouDir').value;
        const proposer = $('ouProp').value;
        const acceptor = $('ouAcc').value;
        if(proposer===acceptor){ alert('Choose different players for proposer and acceptor.'); return;}
        hole.bets.push({id:crypto.randomUUID(), type:'OU', stake, playerId:pid, threshold:th, direction:dir, proposerId:proposer, acceptorId:acceptor, resolved:false});
        resolveBets(); // maybe instant if score exists
      }
      closeBet();
      persist();
      renderBets();
    }

    function settleCTP_LD(type, stake, winnerId){
      // Winner receives stake from each OTHER player (simple pool)
      S.players.forEach(p=>{
        if(p.id===winnerId) return;
        p.points -= stake;
      });
      const winP = S.players.find(p=>p.id===winnerId);
      winP.points += stake * (S.players.length - 1);
      // mark resolved
      const hole = S.holes[S.currentHole-1];
      hole.bets = hole.bets.map(b=> b.type===type && !b.resolved ? {...b, resolved:true} : b);
      refreshRound();
    }

    function resolveBets(){
      const hole = S.holes[S.currentHole-1];
      const pending = hole.bets.filter(b=>b.type==='OU' && !b.resolved);
      pending.forEach(b=>{
        const sc = hole.scores[b.playerId];
        if(typeof sc === 'number'){
          const cond = b.direction==='over' ? (sc > b.threshold) : (sc < b.threshold);
          const from = cond ? b.acceptorId : b.proposerId;
          const to = cond ? b.proposerId : b.acceptorId;
          const payer = S.players.find(p=>p.id===from);
          const rec = S.players.find(p=>p.id===to);
          payer.points -= b.stake;
          rec.points += b.stake;
          b.resolved = true;
        }
      });
      refreshRound();
    }

    function renderBets(){
      const hole = S.holes[S.currentHole-1];
      const el = $('betsList'); el.innerHTML='';
      if(!hole.bets.length){ el.innerHTML = '<div class="small">No bets yet.</div>'; return; }
      hole.bets.forEach(b=>{
        let title='', meta='';
        if(b.type==='CTP' || b.type==='LD'){
          const w = S.players.find(p=>p.id===b.winnerId); 
          title = (b.type==='CTP'?'Closest to the Pin':'Longest Drive');
          meta = `Winner: ${w?.name||'?'} • Stake ${b.stake} pts`;
        } else {
          const pp = S.players.find(p=>p.id===b.proposerId);
          const aa = S.players.find(p=>p.id===b.acceptorId);
          const onp = S.players.find(p=>p.id===b.playerId);
          title = 'Over/Under';
          meta = `${pp?.name||'?'} vs ${aa?.name||'?'} on ${onp?.name||'?'} ${b.direction} ${b.threshold} • ${b.stake} pts`;
        }
        const status = b.resolved ? '<span class="pill">Resolved</span>' : '<span class="pill">Pending</span>';
        const row = document.createElement('div');
        row.className='bet';
        row.innerHTML = `<div><strong>${title}</strong><div class="meta">${meta}</div></div><div>${status}</div>`;
        el.appendChild(row);
      });
    }

    function nextHole(){
      if(S.currentHole < S.totalHoles){
        S.currentHole += 1;
        persist();
        openRound();
      } else {
        endRound();
      }
    }

    function updateSettlePreview(){
      const nums = S.players.map(p=>p.points - S.startingPoints);
      const value = S.pointValue;
      const names = S.players.map(p=>p.name);
      const parts = names.map((n,i)=> `${n}: ${(nums[i]>0?'+':'')}${nums[i]} (${nums[i]>=0?'+':''}$${(nums[i]*value).toFixed(2)})`);
      $('settlePreview').textContent = parts.join('  •  ');
    }

    function refreshUI(){
      // noop for now
    }

    // Deep link import handler
    (function(){
      if(location.hash.startsWith('#import=')){
        try{
          const data = location.hash.slice(8);
          const obj = JSON.parse(decodeURIComponent(escape(atob(data))));
          S = obj;
          persist();
          openLobby();
          alert('Round imported. Add yourself and start!');
        }catch(e){}
      } else {
        const last = localStorage.getItem('parlayd:last');
        if(last){
          const st = loadByCode(last);
          if(st){ S=st; openLobby(); return; }
        }
      }
    })();
  </script>
</body>
</html>
