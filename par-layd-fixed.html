<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Par‑Lay’d – Side Action Tracker</title>
  <style>
    :root{
      --bg:#0f1115; --card:#171922; --ink:#e8ecf1; --muted:#9aa3af; --accent:#7dd3fc; --accent2:#b4f5c3;
      --danger:#f87171; --warn:#fbbf24; --ok:#34d399; --line:#232839; --chip:#1f2433; --btn:#0ea5e9;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:var(--accent)}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    header{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:8px 0 18px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));
      display:grid;place-items:center;color:#001b2a;font-weight:900}
    .h1{font-size:20px;font-weight:800}
    .sub{font-size:12px;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px 16px;margin:12px 0;box-shadow:0 10px 24px rgba(0,0,0,.28)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1 1 240px;min-width:220px}
    label{font-size:12px;color:var(--muted);display:block;margin:8px 0 6px}
    input,select,button,textarea{width:100%;padding:12px 12px;border-radius:10px;border:1px solid var(--line);background:#0c0f16;color:var(--ink);outline:none}
    input:focus,select:focus,textarea:focus{border-color:#2b5cff;box-shadow:0 0 0 3px rgba(43,92,255,.15)}
    button{background:var(--btn);border:none;color:white;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;border:1px solid var(--line);color:var(--ink)}
    button.warn{background:var(--warn);color:#0c0c0c}
    button.danger{background:var(--danger)}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:var(--chip);border:1px solid var(--line);border-radius:999px;font-size:12px;color:var(--muted)}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .center{text-align:center}
    .right{justify-content:flex-end}
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt24{margin-top:24px}
    .small{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:var(--line);margin:12px -2px}
    .list{display:grid;gap:8px}
    .bet{display:flex;justify-content:space-between;align-items:center;background:#0c0f16;border:1px solid var(--line);padding:10px;border-radius:10px}
    .bet .meta{font-size:12px;color:var(--muted)}
    .pill{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:var(--chip)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .holehead{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left}
    .table th{color:var(--muted);font-weight:600;font-size:12px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .qr{display:grid;place-items:center;background:#0c0f16;border:1px dashed var(--line);padding:8px;border-radius:12px}
    @media(max-width:720px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">PL</div>
        <div>
          <div class="h1">Par‑Lay’d</div>
          <div class="sub">The easiest way to track and settle side action</div>
        </div>
      </div>
      <div><span class="chip">Prototype • Offline • No signup</span></div>
    </header>

    <!-- Auth/Create/Join -->
    <div id="screen-auth" class="card">
      <div class="row">
        <div class="col">
          <label>Your name</label>
          <input id="meName" placeholder="e.g., Ryan" />
        </div>
        <div class="col">
          <label>Your Venmo (optional)</label>
          <input id="meVenmo" placeholder="@your-handle" />
        </div>
      </div>
      <div class="grid mt16">
        <div class="card">
          <div class="h1" style="font-size:16px">Create a new round</div>
          <div class="row">
            <div class="col">
              <label>Starting points per player</label>
              <input id="startPts" type="number" value="1000"/>
            </div>
            <div class="col">
              <label>Point value ($ per point)</label>
              <input id="ptValue" type="number" value="1" step="0.01"/>
            </div>
          </div>
          <div class="row mt12">
            <div class="col">
              <label>Max players</label>
              <select id="maxPlayers">
                <option value="2">2</option><option value="3">3</option><option value="4" selected>4</option>
              </select>
            </div>
            <div class="col">
              <label>Holes</label>
              <select id="holes">
                <option value="9">9</option><option value="18" selected>18</option>
              </select>
            </div>
          </div>
          <div class="mt16"><button id="btnCreate">Create Round</button></div>
          <div class="small mt8">You’ll be the host. Share the link for a friend to import on their phone.</div>
        </div>
        <div class="card">
          <div class="h1" style="font-size:16px">Join a round</div>
          <label>Enter 4‑letter code</label>
          <input id="joinCode" placeholder="ABCD" maxlength="4" />
          <div class="mt12"><button class="ghost" id="btnJoinLocal">Join (same device)</button></div>
          <div class="divider"></div>
          <div class="small">On a different phone? Paste an import link below (or tap it):</div>
          <textarea id="importLink" class="mt8" rows="2" placeholder="Paste shared link here"></textarea>
          <div class="toolbar mt8">
            <button id="btnImport">Import & Join</button>
            <button class="ghost" id="btnOpenLink">Open link</button>
          </div>
          <div class="small mt8">Tip: Snapshot sharing, not live sync. Pass‑and‑play is simplest.</div>
        </div>
      </div>
    </div>

    <!-- Lobby -->
    <div id="screen-lobby" class="card" style="display:none">
      <div class="row">
        <div class="col">
          <div class="h1" style="font-size:18px">Round Lobby</div>
          <div class="small">Code: <span id="lobbyCode" class="mono pill"></span></div>
        </div>
        <div class="col right toolbar">
          <button class="ghost" id="btnShare">Share</button>
          <button class="warn" id="btnStartRound">Start Round</button>
        </div>
      </div>
      <div class="divider"></div>
      <div class="row">
        <div class="col">
          <label>Players</label>
          <div id="players" class="list"></div>
          <div class="row mt12">
            <div class="col"><input id="newPlayerName" placeholder="Add player name"/></div>
            <div class="col"><input id="newPlayerVenmo" placeholder="Venmo (optional)"/></div>
          </div>
          <div class="mt8"><button class="ghost" id="btnAddPlayer">Add Player</button></div>
        </div>
        <div class="col">
          <label>Round Settings</label>
          <div class="chips">
            <span class="chip">Starting: <span id="labStart"></span> pts</span>
            <span class="chip">$<span id="labValue"></span>/pt</span>
            <span class="chip"><span id="labHoles"></span> holes</span>
            <span class="chip"><span id="labMax"></span> max players</span>
          </div>
          <div class="mt12 small">Host: <span id="labHost"></span></div>
          <div class="mt12"><button class="danger" id="btnReset1">Reset & Quit</button></div>
        </div>
      </div>
      <div id="shareArea" class="mt16" style="display:none">
        <div class="row">
          <div class="col">
            <div class="qr"><div id="qrcode">(QR preview omitted in this build)</div></div>
          </div>
          <div class="col">
            <label>Shareable import link</label>
            <textarea id="shareLink" rows="4" readonly></textarea>
            <div class="mt8"><button class="ghost" id="btnCopyShare">Copy Link</button> <span class="small">or share via iMessage</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Round -->
    <div id="screen-round" style="display:none">
      <div class="card">
        <div class="holehead">
          <div>
            <div class="h1" style="font-size:18px">Hole <span id="holeNum"></span>/<span id="totalHoles"></span></div>
            <div class="small">Code: <span id="roundCode" class="mono"></span> • $<span id="valueNow"></span>/pt</div>
          </div>
          <div class="toolbar">
            <button class="ghost" id="btnLobby">Lobby</button>
            <button class="ghost" id="btnShare2">Share</button>
            <button class="warn" id="btnNextHole">Next Hole →</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <div class="col">
            <label>Scores (strokes)</label>
            <table class="table">
              <thead><tr id="scoreHead"></tr></thead>
              <tbody><tr id="scoreRow"></tr></tbody>
            </table>
            <div class="small mt8">Enter strokes; O/U auto‑resolves when possible.</div>
          </div>
          <div class="col">
            <label>Add a bet</label>
            <div class="grid">
              <button id="btnCTP">Closest to the Pin</button>
              <button id="btnLD">Longest Drive</button>
              <button id="btnOU">Over / Under</button>
            </div>
            <div id="betForm" class="mt12" style="display:none"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <label>Active bets on this hole</label>
        <div id="betsList" class="list"></div>
      </div>

      <div class="card">
        <label>Points</label>
        <table class="table" id="pointsTable"></table>
        <div class="small mt8">Settlement preview: <span id="settlePreview"></span></div>
      </div>

      <div class="card">
        <div class="row">
          <div class="col">
            <div class="h1" style="font-size:16px">End Round</div>
            <div class="small">Show who owes who at $<span id="valueEnd"></span>/pt. Use Venmo outside the app.</div>
          </div>
          <div class="col right"><button class="danger" id="btnFinish">Finish & Show Settlement</button></div>
        </div>
      </div>
    </div>

    <!-- Settlement -->
    <div id="screen-settle" class="card" style="display:none">
      <div class="h1" style="font-size:18px">Round Settlement</div>
      <div id="settleTable" class="mt12"></div>
      <div class="mt16">
        <button class="ghost" id="btnBackToRound">Back to Round</button>
        <button class="danger" id="btnReset2">Reset & Quit</button>
      </div>
    </div>
  </div>

  <script>
    // Helpers
    const $ = (id)=>document.getElementById(id);
    const byId = (id)=>document.getElementById(id);
    const on = (id, evt, fn)=>byId(id).addEventListener(evt, fn);
    let S = null;

    function randCode(){
      const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let out=''; for(let i=0;i<4;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }
    function show(id, on){ byId(id).style.display = on ? 'block':'none'; }
    function persist(){
      if(!S) return;
      localStorage.setItem('parlayd:'+S.code, JSON.stringify(S));
      localStorage.setItem('parlayd:last', S.code);
    }
    function loadByCode(code){
      try{ return JSON.parse(localStorage.getItem('parlayd:'+code)); }catch(e){ return null; }
    }

    // Creation / Join
    function createGame(){
      const name = byId('meName').value.trim() || 'Player';
      const venmo = byId('meVenmo').value.trim();
      const startPts = Math.max(0, parseInt(byId('startPts').value||'1000',10));
      const ptValue = Math.max(0.01, parseFloat(byId('ptValue').value||'1'));
      const holes = parseInt(byId('holes').value,10);
      const maxP = parseInt(byId('maxPlayers').value,10);
      const code = randCode();
      const meId = crypto.randomUUID();

      S = {
        code, createdAt: Date.now(), startingPoints: startPts, pointValue: ptValue, totalHoles: holes, maxPlayers: maxP,
        players: [{id:meId, name, venmo, points:startPts}], host:{name, venmo}, meId, currentHole:1,
        holes: Array.from({length: holes}, (_,i)=>({number:i+1, scores:{}, bets:[]}))
      };
      persist();
      openLobby();
    }
    function addPlayer(){
      if(!S) return;
      const nm = byId('newPlayerName').value.trim();
      const vv = byId('newPlayerVenmo').value.trim();
      if(!nm) return;
      if(S.players.length >= S.maxPlayers){ alert('Player limit reached'); return; }
      S.players.push({id:crypto.randomUUID(), name:nm, venmo:vv, points:S.startingPoints});
      byId('newPlayerName').value=''; byId('newPlayerVenmo').value='';
      persist(); refreshLobby();
    }
    function joinLocal(){
      const code = byId('joinCode').value.trim().toUpperCase();
      const state = loadByCode(code);
      if(!state){ alert('Round not found on this device. Use Share → Import link.'); return; }
      S = state;
      const nm = byId('meName').value.trim() || 'Player';
      const vv = byId('meVenmo').value.trim();
      if(S.players.length < S.maxPlayers){
        S.players.push({id: crypto.randomUUID(), name:nm, venmo:vv, points:S.startingPoints});
      }
      S.meId = S.meId || S.players[0].id;
      persist(); openLobby();
    }
    function exportLink(){
      const payload = btoa(unescape(encodeURIComponent(JSON.stringify(S))));
      const url = location.href.split('#')[0];
      return url + '#import=' + payload;
    }
    function shareGame(fromRound=false){
      if(!S) return;
      const link = exportLink();
      byId('shareLink').value = link;
      show('shareArea', true);
      if(fromRound) alert('Share link is prepared in the Lobby.');
      openLobby();
    }
    function importFromLink(){
      const link = byId('importLink').value.trim();
      const idx = link.indexOf('#import=');
      if(idx === -1){ alert('Invalid link.'); return; }
      const data = link.slice(idx + 8);
      try{
        const obj = JSON.parse(decodeURIComponent(escape(atob(data))));
        S = obj;
        const nm = byId('meName').value.trim() || 'Player';
        const vv = byId('meVenmo').value.trim();
        if(!S.players.find(p=>p.name.toLowerCase()===nm.toLowerCase()) && S.players.length < S.maxPlayers){
          S.players.push({id: crypto.randomUUID(), name:nm, venmo:vv, points:S.startingPoints});
        }
        S.meId = S.meId || S.players[0].id;
        persist(); openLobby();
      } catch(e){ alert('Could not import.'); }
    }
    function startRound(){
      if(!S) return;
      if(S.players.length < 2){ alert('Add at least 2 players to start.'); return; }
      openRound();
    }
    function openLobby(){
      show('screen-auth', false); show('screen-round', false); show('screen-settle', false); show('screen-lobby', true);
      refreshLobby();
    }
    function openRound(){
      show('screen-auth', false); show('screen-lobby', false); show('screen-settle', false); show('screen-round', true);
      refreshRound();
    }

    // Lobby UI
    function refreshLobby(){
      if(!S) return;
      byId('lobbyCode').textContent = S.code;
      byId('labStart').textContent = S.startingPoints;
      byId('labValue').textContent = S.pointValue;
      byId('labHoles').textContent = S.totalHoles;
      byId('labMax').textContent = S.maxPlayers;
      byId('labHost').textContent = S.host.name + (S.host.venmo? ' • '+S.host.venmo:'');
      const list = byId('players'); list.innerHTML = '';
      S.players.forEach((p,idx)=>{
        const row = document.createElement('div');
        row.className = 'bet';
        row.innerHTML = `<div><strong>${p.name}</strong> ${p.venmo?`<span class="small">(${p.venmo})</span>`:''}
          <div class="meta">Points: ${p.points}</div></div>
          <div>${idx>0?`<button class="ghost" data-kick="${p.id}">Remove</button>`:''}</div>`;
        list.appendChild(row);
      });
      // attach kick handlers
      list.querySelectorAll('button[data-kick]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-kick');
          S.players = S.players.filter(p=>p.id!==id); persist(); refreshLobby();
        });
      });
    }

    // Round UI
    function refreshRound(){
      if(!S) return;
      byId('holeNum').textContent = S.currentHole;
      byId('totalHoles').textContent = S.totalHoles;
      byId('roundCode').textContent = S.code;
      byId('valueNow').textContent = S.pointValue.toFixed(2);

      const sh = byId('scoreHead'); sh.innerHTML='';
      const sr = byId('scoreRow'); sr.innerHTML='';
      const hole = S.holes[S.currentHole-1];
      const trh = document.createElement('tr'); const trb = document.createElement('tr');
      S.players.forEach(p=>{
        const th = document.createElement('th'); th.textContent = p.name; trh.appendChild(th);
        const td = document.createElement('td');
        const v = (hole.scores[p.id]??'');
        td.innerHTML = `<input type="number" min="1" value="${v}" data-score="${p.id}" />`;
        trb.appendChild(td);
      });
      sh.appendChild(trh); sr.appendChild(trb);
      sr.querySelectorAll('input[data-score]').forEach(inp=>{
        inp.addEventListener('input', e=>{
          const pid = inp.getAttribute('data-score');
          const val = e.target.value;
          setScore(pid, val);
        });
      });

      // Points table
      const ptT = byId('pointsTable');
      let h = '<tr><th>Player</th><th>Points</th></tr>';
      S.players.forEach(p=>{ h += `<tr><td>${p.name}</td><td class="mono">${p.points.toFixed(0)}</td></tr>`; });
      ptT.innerHTML = h;

      renderBets();
      updateSettlePreview();
    }

    function setScore(pid, val){
      const hole = S.holes[S.currentHole-1];
      if(val==='') delete hole.scores[pid];
      else hole.scores[pid] = parseInt(val,10);
      resolveBets();
      persist();
    }

    // Bets
    function openBet(type){
      const c = byId('betForm'); c.style.display='block';
      if(type==='CTP' || type==='LD'){
        const title = type==='CTP'?'Closest to the Pin':'Longest Drive';
        c.innerHTML = `
          <div class="card">
            <div class="h1" style="font-size:16px">${title}</div>
            <div class="row">
              <div class="col"><label>Stake (points)</label><input id="betStake" type="number" value="50"/></div>
              <div class="col"><label>Winner</label>
                <select id="betWinner">${S.players.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}</select>
              </div>
            </div>
            <div class="toolbar mt12">
              <button id="btnAddBetNow">Add Bet</button>
              <button class="ghost" id="btnCancelBet">Cancel</button>
            </div>
          </div>`;
        on('btnAddBetNow','click', ()=>{
          const stake = Math.max(1, parseInt(byId('betStake').value||'0',10));
          const winner = byId('betWinner').value;
          addBet({type, stake, winnerId:winner});
        });
        on('btnCancelBet','click', ()=>{ c.style.display='none'; c.innerHTML=''; });
      } else if(type==='OU'){
        c.innerHTML = `
          <div class="card">
            <div class="h1" style="font-size:16px">Over / Under</div>
            <div class="row">
              <div class="col"><label>Player being bet on</label>
                <select id="ouPlayer">${S.players.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}</select></div>
              <div class="col"><label>Threshold (strokes)</label><input id="ouThresh" type="number" value="5"/></div>
            </div>
            <div class="row mt12">
              <div class="col"><label>Direction</label>
                <select id="ouDir"><option value="under">Under</option><option value="over">Over</option></select></div>
              <div class="col"><label>Stake (points)</label><input id="ouStake" type="number" value="50"/></div>
            </div>
            <div class="row mt12">
              <div class="col"><label>Proposer</label>
                <select id="ouProp">${S.players.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}</select></div>
              <div class="col"><label>Acceptor</label>
                <select id="ouAcc">${S.players.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}</select></div>
            </div>
            <div class="toolbar mt12">
              <button id="btnAddOU">Add Bet</button>
              <button class="ghost" id="btnCancelOU">Cancel</button>
            </div>
            <div class="small mt8">Resolves automatically once that player's score is entered.</div>
          </div>`;
        on('btnAddOU','click', ()=>{
          const stake = Math.max(1, parseInt(byId('ouStake').value||'0',10));
          const pid = byId('ouPlayer').value;
          const th = parseInt(byId('ouThresh').value||'5',10);
          const dir = byId('ouDir').value;
          const proposer = byId('ouProp').value;
          const acceptor = byId('ouAcc').value;
          if(proposer===acceptor){ alert('Choose different players for proposer and acceptor.'); return; }
          addBet({type:'OU', stake, playerId:pid, threshold:th, direction:dir, proposerId:proposer, acceptorId:acceptor});
        });
        on('btnCancelOU','click', ()=>{ c.style.display='none'; c.innerHTML=''; });
      }
    }
    function addBet(b){
      const hole = S.holes[S.currentHole-1];
      if(b.type==='CTP' || b.type==='LD'){
        hole.bets.push({id:crypto.randomUUID(), ...b, resolved:false});
        // settle immediately
        S.players.forEach(p=>{ if(p.id!==b.winnerId) p.points -= b.stake; });
        const winP = S.players.find(p=>p.id===b.winnerId); winP.points += b.stake * (S.players.length - 1);
        hole.bets = hole.bets.map(x=> x.type===b.type && !x.resolved ? {...x, resolved:true} : x);
      } else {
        hole.bets.push({id:crypto.randomUUID(), ...b, resolved:false});
      }
      byId('betForm').style.display='none'; byId('betForm').innerHTML='';
      persist(); renderBets(); refreshRound();
    }
    function resolveBets(){
      const hole = S.holes[S.currentHole-1];
      hole.bets.filter(x=>x.type==='OU' && !x.resolved).forEach(b=>{
        const sc = hole.scores[b.playerId];
        if(typeof sc === 'number'){
          const cond = b.direction==='over' ? (sc > b.threshold) : (sc < b.threshold);
          const from = cond ? b.acceptorId : b.proposerId;
          const to = cond ? b.proposerId : b.acceptorId;
          const payer = S.players.find(p=>p.id===from);
          const rec = S.players.find(p=>p.id===to);
          payer.points -= b.stake; rec.points += b.stake; b.resolved = true;
        }
      });
      refreshRound();
    }
    function renderBets(){
      const hole = S.holes[S.currentHole-1];
      const el = byId('betsList'); el.innerHTML='';
      if(!hole.bets.length){ el.innerHTML = '<div class="small">No bets yet.</div>'; return; }
      hole.bets.forEach(b=>{
        let title='', meta='';
        if(b.type==='CTP' || b.type==='LD'){
          const w = S.players.find(p=>p.id===b.winnerId);
          title = (b.type==='CTP'?'Closest to the Pin':'Longest Drive');
          meta = `Winner: ${w?.name||'?'} • Stake ${b.stake} pts`;
        } else {
          const pp = S.players.find(p=>p.id===b.proposerId);
          const aa = S.players.find(p=>p.id===b.acceptorId);
          const onp = S.players.find(p=>p.id===b.playerId);
          title = 'Over/Under';
          meta = `${pp?.name||'?'} vs ${aa?.name||'?'} on ${onp?.name||'?'} ${b.direction} ${b.threshold} • ${b.stake} pts`;
        }
        const status = b.resolved ? '<span class="pill">Resolved</span>' : '<span class="pill">Pending</span>';
        const row = document.createElement('div'); row.className='bet';
        row.innerHTML = `<div><strong>${title}</strong><div class="meta">${meta}</div></div><div>${status}</div>`;
        el.appendChild(row);
      });
    }
    function nextHole(){
      if(S.currentHole < S.totalHoles){ S.currentHole += 1; persist(); openRound(); }
      else { endRound(); }
    }
    function endRound(){
      const deltas = S.players.map(p=>({name:p.name, venmo:p.venmo, delta:p.points - S.startingPoints}));
      const winners = deltas.filter(d=>d.delta>0).sort((a,b)=>b.delta-a.delta);
      const losers = deltas.filter(d=>d.delta<0).sort((a,b)=>a.delta-b.delta);
      const value = S.pointValue;
      let html = '<table class="table"><tr><th>Who pays</th><th>Who receives</th><th>Points</th><th>Approx $</th></tr>';
      let i=0,j=0;
      while(i<losers.length && j<winners.length){
        const pay = losers[i], rec = winners[j];
        const pts = Math.min(-pay.delta, rec.delta);
        html += `<tr><td>${pay.name}${pay.venmo?` <span class="small">(${pay.venmo})</span>`:''}</td>
                     <td>${rec.name}${rec.venmo?` <span class="small">(${rec.venmo})</span>`:''}</td>
                     <td class="mono">${pts.toFixed(0)}</td>
                     <td class="mono">$${(pts*value).toFixed(2)}</td></tr>`;
        pay.delta += pts; rec.delta -= pts;
        if(pay.delta===0) i++; if(rec.delta===0) j++;
      }
      html += '</table>';
      byId('settleTable').innerHTML = html;
      byId('valueEnd').textContent = S.pointValue.toFixed(2);
      show('screen-round', false); show('screen-settle', true);
    }
    function updateSettlePreview(){
      const nums = S.players.map(p=>p.points - S.startingPoints);
      const value = S.pointValue;
      const names = S.players.map(p=>p.name);
      const parts = names.map((n,i)=> `${n}: ${(nums[i]>0?'+':'')}${nums[i]} (${nums[i]>=0?'+':''}$${(nums[i]*value).toFixed(2)})`);
      byId('settlePreview').textContent = parts.join('  •  ');
    }

    // Wiring
    on('btnCreate','click', createGame);
    on('btnJoinLocal','click', joinLocal);
    on('btnImport','click', importFromLink);
    on('btnOpenLink','click', ()=>{ const v = byId('importLink').value.trim(); if(v) location.href=v; });
    on('btnShare','click', ()=>shareGame(false));
    on('btnStartRound','click', startRound);
    on('btnAddPlayer','click', addPlayer);
    on('btnReset1','click', ()=>{ localStorage.removeItem('parlayd:'+S.code); S=null; location.reload(); });
    on('btnLobby','click', ()=>openLobby());
    on('btnShare2','click', ()=>shareGame(true));
    on('btnNextHole','click', nextHole);
    on('btnFinish','click', endRound);
    on('btnBackToRound','click', ()=>openRound());
    on('btnReset2','click', ()=>{ localStorage.removeItem('parlayd:'+S.code); S=null; location.reload(); });

    // Deep link import on load
    (function(){
      const hash = location.hash || '';
      if(hash.startsWith('#import=')){
        try{
          const data = hash.slice(8);
          const obj = JSON.parse(decodeURIComponent(escape(atob(data))));
          S = obj; persist(); openLobby(); alert('Round imported. Add yourself and start!');
          return;
        }catch(e){}
      }
      const last = localStorage.getItem('parlayd:last');
      if(last){
        const st = loadByCode(last);
        if(st){ S=st; openLobby(); return; }
      }
    })();
  </script>
</body>
</html>
